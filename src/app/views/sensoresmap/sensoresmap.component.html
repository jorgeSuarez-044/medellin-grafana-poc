<div class="container">
  <h2 class="page-title">Ciudad Inteligente - Sensores de ruido</h2>

  <div class="iframe-container">
    <!-- <iframe
    src="http://grafana-fiware.apps.preprodalcaldia.medellin.gov.co/territoriointeligente/d/sr_ma/ruido-map?orgId=1&from=1739789553128&to=1740394353128&viewPanel=1&kiosk"
    allowfullscreen>
  </iframe> -->



    <h3>Consultar hist贸rico para: {{ getShortId(selectedSensor) }}</h3>

    <div class="date-controls">
      <div class="sensor-container">
        <h2>Selecciona un sensor de ruido</h2>

        <div *ngIf="isLoading" class="loading">
          Cargando sensores...
        </div>

        <div *ngIf="errorMessage" class="error">
          {{ errorMessage }}
          <button (click)="loadSensors()">Reintentar</button>
        </div>

        <div *ngIf="!isLoading && !errorMessage">
          <select [(ngModel)]="selectedSensor" (change)="onSensorSelect()" class="sensor-select">
            <option value="" disabled selected>Selecciona un sensor</option>
            <option *ngFor="let sensor of sensors" [value]="sensor.entity_id">
              {{ getShortId(sensor.entity_id) }} - {{ sensor.laeq_slow }} dB
            </option>
          </select>

          <div *ngIf="selectedSensor" class="selected-info">
            Sensor seleccionado: {{ getShortId(selectedSensor) }}
          </div>
        </div>
      </div>

   <div>
  <label for="desde">Desde:</label>
  <input type="date" id="desde" [(ngModel)]="desdeFecha" (change)="actualizarUrlGrafana()">
</div>

<div>
  <label for="hasta">Hasta:</label>
  <input type="date" id="hasta" [(ngModel)]="hastaFecha" (change)="actualizarUrlGrafana()">
</div>
      <div>
        <button (click)="getHistoricData()" [disabled]="!selectedSensor || loadingHistoric">
          {{ loadingHistoric ? 'Cargando...' : 'Consultar' }}
        </button>
      </div>
    </div>

    <div *ngIf="errorHistoric" class="error">
      {{ errorHistoric }}
    </div>

    <div *ngIf="historicData.length > 0" class="historic-results">
      <h3>Resultados hist贸ricos (promedio: {{ historicAvg | number:'1.1-1' }} dB)</h3>
      <div class="chart-container">
        <!-- Aqu铆 podr铆as agregar un gr谩fico con los datos hist贸ricos -->
      </div>
    </div>

    <h2> Sensores de Ruido</h2>

    <div class="map-container">
      <h3>Tablero Ejecutivo</h3>
      <h4>Mapa de sensores</h4>
      <div *ngIf="loading" class="loading-overlay">

        <mat-spinner></mat-spinner>
        <p>Cargando datos de sensores...</p>
      </div>

      <div *ngIf="error" class="error-overlay">
        <mat-icon>error_outline</mat-icon>
        <p>Error al cargar los datos de los sensores</p>
        <button mat-raised-button color="primary" (click)="loadSensorData()">Reintentar</button>
      </div>

      <div class="map-layout">

        <div class="half-layout">
          <div #map id="noise-sensor-map"></div>
        </div>


        <div class="half-layout">
      <iframe 
  [src]="urlGrafanaSegura" 
  allowfullscreen 
  style="width: 90%; height: 100%; border: none; border-radius: 12px;">
</iframe>
        </div>


        <div class="details-panel" *ngIf="selectedSensorDetails">
          <div class="panel-header">
            <h3>Detalles del Sensor</h3>
            <button mat-icon-button (click)="closeDetails()">
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <div id="sensor-details" class="sensor-details">
            <div class="detail-row">
              <span class="detail-label">ID:</span>
              <span class="detail-value">{{ getShortId(selectedSensorDetails.id) }}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label">Nivel de Ruido:</span>
              <span class="detail-value">{{ selectedSensorDetails.laeq }} dB ({{ selectedSensorDetails.levelName
                }})</span>
            </div>

            <div class="detail-row">
              <span class="detail-label">ltima actualizaci贸n:</span>
              <span class="detail-value">{{ selectedSensorDetails.lastUpdate | date:'medium' }}</span>
            </div>

            <div *ngIf="historicAvg" class="detail-row">
              <span class="detail-label">Promedio hist贸rico:</span>
              <span class="detail-value">{{ historicAvg | number:'1.1-1' }} dB</span>
            </div>
          </div>
        </div>
      </div>

      <div class="map-legend">
        <h4>Leyenda</h4>
        <div class="legend-item">
          <span class="legend-color low"></span>
          <span>Bajo (&lt;55 dB)</span>
        </div>
        <div class="legend-item">
          <span class="legend-color moderate"></span>
          <span>Moderado (55-70 dB)</span>
        </div>
        <div class="legend-item">
          <span class="legend-color high"></span>
          <span>Alto (&gt;70 dB)</span>
        </div>
      </div>


    </div>
  </div>



</div>