<div class="container">
  <h1>Gestión de Usuarios</h1>

  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner"></div>
    <p>Cargando...</p>
  </div>

  <div class="tabs">
    <button [class.active]="activeTab === 'usuarios'" (click)="changeTab('usuarios')">Usuarios</button>
    <button [class.active]="activeTab === 'roles'" (click)="changeTab('roles')">Roles</button>
    <button [class.active]="activeTab === 'grafana-roles'" (click)="changeTab('grafana-roles')">Roles Grafana</button>
    <button [class.active]="activeTab === 'auditoria'" (click)="changeTab('auditoria')">Auditoría</button>
    <button [class.active]="activeTab === 'subdimensiones'"
      (click)="changeTab('subdimensiones')">Subdimensiones</button>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'subdimensiones'">
    <app-mde-crud></app-mde-crud>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'usuarios'">
    <div class="user-form">
      <h2>{{ selectedUser ? 'Editar Usuario' : 'Crear Usuario' }}</h2>
      <form [formGroup]="userForm" (ngSubmit)="selectedUser ? updateUser() : createUser()">
        <div class="form-group">
          <label>Nombre de usuario *</label>
          <input type="text" formControlName="username" placeholder="Ingrese nombre de usuario"
            [attr.disabled]="selectedUser ? 'disabled' : null">
          <div class="error-message" *ngIf="userForm.get('username')?.invalid && userForm.get('username')?.touched">
            <span *ngIf="userForm.get('username')?.errors?.['required']">Este campo es requerido</span>
          </div>
        </div>
        <div class="form-group">
          <label>Correo electrónico *</label>
          <input type="email" formControlName="email" placeholder="Ingrese correo electrónico">
          <div class="error-message" *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched">
            Ingrese un correo electrónico válido
          </div>
        </div>
        <div class="form-group">
          <label>Nombre *</label>
          <input type="text" formControlName="firstName" placeholder="Ingrese nombre">
          <div class="error-message" *ngIf="userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched">
            Este campo es requerido
          </div>
        </div>
        <div class="form-group">
          <label>Apellido *</label>
          <input type="text" formControlName="lastName" placeholder="Ingrese apellido">
          <div class="error-message" *ngIf="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched">
            Este campo es requerido
          </div>
        </div>
        <div class="form-group">
          <label>Habilitado</label>
          <input type="checkbox" formControlName="enabled">
        </div>
        <div class="form-actions">
          <button type="submit" [disabled]="!userForm.valid">
            {{ selectedUser ? 'Actualizar' : 'Crear' }}
          </button>
          <button type="button" *ngIf="selectedUser" (click)="cancelEdit()">Cancelar</button>
          <button type="button" *ngIf="selectedUser" (click)="openPasswordModal()" class="password-btn">
            Asignar Contraseña
          </button>
          <button type="button" *ngIf="selectedUser" (click)="openRolesModal()" class="roles-btn">
            Asignar Roles
          </button>
          <button type="button" *ngIf="selectedUser" (click)="openGrafanaRolesModal()" class="grafana-roles-btn">
            Asignar Roles Grafana
          </button>
        </div>
      </form>
    </div>

    <div class="user-list">
      <h2>Lista de Usuarios</h2>
      <div class="search-bar">
        <input type="text" placeholder="Buscar usuarios..." [(ngModel)]="searchTerm" (input)="filterUsers()">
      </div>
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Usuario</th>
            <th>Estado</th>
           
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of filteredUsers">
            <td>{{ user.firstName }} {{ user.lastName }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.username }}</td>
            <td>
              <span [class.active]="user.enabled" [class.inactive]="!user.enabled">
                {{ user.enabled ? 'Activo' : 'Inactivo' }}
              </span>
            </td>
      
            <td class="actions">
              <button (click)="editUser(user)" class="edit-btn">Editar</button>
              <button (click)="confirmDelete(user.id)" class="delete-btn">Eliminar</button>
              <!-- <button (click)="openRolesViewModal(user.id)" class="view-roles-btn">Ver Roles</button> -->
            </td>
          </tr>
        </tbody>
      </table>
      <div *ngIf="filteredUsers.length === 0" class="no-results">
        No se encontraron usuarios
      </div>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'roles'">
    <div class="user-list">
      <h2>Roles del Sistema</h2>

      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Usuarios Asignados</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let role of roles">
            <td>{{ role.name }}</td>
            <td>{{ role.description || 'Sin descripción' }}</td>
            <td>
              <span *ngFor="let user of getUsersWithRole(role.id)" class="user-badge">
                {{ user.username }}
              </span>
              <span *ngIf="getUsersWithRole(role.id).length === 0">Ningún usuario</span>
            </td>
            <td>
              <button (click)="viewRoleDetails(role)">Detalles</button>
            </td>
          </tr>
        </tbody>
      </table>
      <div *ngIf="roles.length === 0" class="no-results">
        No se encontraron roles del sistema
      </div>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'grafana-roles'">
    <div class="user-list">
      <h2>Roles de Grafana</h2>

      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Usuarios Asignados</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let role of grafanaRoles">
            <td>{{ role.name }}</td>
            <td>{{ role.description || 'Sin descripción' }}</td>
            <td>
              <span *ngFor="let user of getUsersWithGrafanaRole(role.id)" class="user-badge">
                {{ user.username }}
              </span>
              <span *ngIf="getUsersWithGrafanaRole(role.id).length === 0">Ningún usuario</span>
            </td>
            <td>
              <button (click)="viewRoleDetails(role, true)">Detalles</button>
            </td>
          </tr>
        </tbody>
      </table>
      <div *ngIf="grafanaRoles.length === 0" class="no-results">
        No se encontraron roles de Grafana
      </div>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'auditoria'">
    <h2>Registros de Auditoría</h2>
    <div class="filters">
      <div class="filter-group">
        <label>Filtrar por tipo:</label>
        <select [(ngModel)]="auditFilter.type" (change)="filterAuditLogs()">
          <option value="">Todos</option>
          <option value="USER">Usuarios</option>
          <option value="ROLE">Roles</option>
          <option value="GRAFANA_ROLE">Roles Grafana</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Filtrar por acción:</label>
        <select [(ngModel)]="auditFilter.action" (change)="filterAuditLogs()">
          <option value="">Todas</option>
          <option value="CREATE">Creación</option>
          <option value="UPDATE">Actualización</option>
          <option value="DELETE">Eliminación</option>
        </select>
      </div>
      <button (click)="clearAuditFilters()">Limpiar Filtros</button>
    </div>
    <div class="audit-logs">
      <table>
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Acción</th>
            <th>Recurso</th>
            <th>Detalles</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let log of filteredAuditLogs">
            <td>{{ log.userId || 'Sistema' }}</td>
            <td>{{ getActionName(log.operationType) }}</td>
            <td>{{ getResourceType(log.resourceType) }}</td>
            <td>{{ log.details || 'N/A' }}</td>
            <td>{{ log.time | date:'dd/MM/yyyy HH:mm' }}</td>
          </tr>
        </tbody>
      </table>
      <div *ngIf="filteredAuditLogs.length === 0" class="no-results">
        No se encontraron registros de auditoría
      </div>
    </div>
  </div>
</div>

<!-- Password Modal -->
<div class="modal-overlay" *ngIf="showPasswordModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Cambiar Contraseña</h3>
      <button (click)="closePasswordModal()" class="close-btn">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Nueva Contraseña</label>
        <input type="password" [(ngModel)]="tempPassword" placeholder="Ingrese la nueva contraseña">
      </div>
    </div>
    <div class="modal-footer">
      <button (click)="closePasswordModal()" class="cancel-btn">Cancelar</button>
      <button (click)="savePassword()" [disabled]="!tempPassword || loading" class="save-btn">
        {{ loading ? 'Guardando...' : 'Guardar' }}
      </button>
    </div>
  </div>
</div>

<!-- Roles Modal -->
<div class="modal-overlay" *ngIf="showRolesModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Asignar Roles del Sistema</h3>
      <button (click)="closeRolesModal()" class="close-btn">&times;</button>
    </div>
    <div class="modal-body">
      <div class="roles-container">
        <div *ngFor="let role of roles" class="role-checkbox">
          <input type="checkbox" [id]="'modal-role-' + role.id" [value]="role.id"
            (change)="onRoleChange($event, role.id)" [checked]="isRoleSelected(role.id)"
            [disabled]="roleAssignmentInProgress">
          <label [for]="'modal-role-' + role.id">{{ role.name }}</label>
          <small *ngIf="role.description" class="role-description">{{ role.description }}</small>
        </div>
      </div>
      <div *ngIf="roleError" class="error-message">{{ roleError }}</div>
    </div>
    <div class="modal-footer">
      <button (click)="closeRolesModal()" class="cancel-btn">Cancelar</button>
      <button (click)="saveRoles()" [disabled]="roleAssignmentInProgress" class="save-btn">
        {{ roleAssignmentInProgress ? 'Guardando...' : 'Guardar' }}
      </button>
    </div>
  </div>
</div>
<div class="modal-overlay" *ngIf="showRolesViewModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Roles del Usuario: {{userRolesDetails?.username}}</h3>
      <button (click)="closeRolesViewModal()" class="close-btn">&times;</button>
    </div>
    <div class="modal-body">
      <div *ngIf="userRolesDetails">
        <div class="user-detail">
          <strong>Nombre:</strong> {{userRolesDetails.firstName}} {{userRolesDetails.lastName}}
        </div>
        <div class="user-detail">
          <strong>Email:</strong> {{userRolesDetails.email}}
        </div>
        
        <h4>Roles del Sistema</h4>
        <div *ngIf="userRolesDetails.user_roles?.length > 0; else noSystemRoles">
          <ul>
            <li *ngFor="let role of userRolesDetails.user_roles">{{role}}</li>
          </ul>
        </div>
        <ng-template #noSystemRoles>
          <p>No tiene roles del sistema asignados</p>
        </ng-template>
        
        <h4>Roles de Grafana</h4>
        <div *ngIf="userRolesDetails.grafana_roles?.length > 0; else noGrafanaRoles">
          <ul>
            <li *ngFor="let role of userRolesDetails.grafana_roles">{{role}}</li>
          </ul>
        </div>
        <ng-template #noGrafanaRoles>
          <p>No tiene roles de Grafana asignados</p>
        </ng-template>
      </div>
    </div>
    <div class="modal-footer">
      <button (click)="closeRolesViewModal()" class="save-btn">Cerrar</button>
    </div>
  </div>
</div>

<!-- Grafana Roles Modal -->
<div class="modal-overlay" *ngIf="showGrafanaRolesModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Asignar Roles de Grafana</h3>
      <button (click)="closeGrafanaRolesModal()" class="close-btn">&times;</button>
    </div>
    <div class="modal-body">
      <div class="roles-container">
        <div *ngFor="let role of grafanaRoles" class="role-checkbox">
          <input type="checkbox" [id]="'modal-grafana-role-' + role.id" [value]="role.id"
            (change)="onRoleChange($event, role.id, true)" [checked]="isRoleSelected(role.id, true)"
            [disabled]="roleAssignmentInProgress">
          <label [for]="'modal-grafana-role-' + role.id">{{ role.name }}</label>
          <small *ngIf="role.description" class="role-description">{{ role.description }}</small>
        </div>
      </div>
      <div *ngIf="roleError" class="error-message">{{ roleError }}</div>
    </div>
    <div class="modal-footer">
      <button (click)="closeGrafanaRolesModal()" class="cancel-btn">Cancelar</button>
      <button (click)="saveGrafanaRoles()" [disabled]="roleAssignmentInProgress" class="save-btn">
        {{ roleAssignmentInProgress ? 'Guardando...' : 'Guardar' }}
      </button>
    </div>
  </div>
</div>